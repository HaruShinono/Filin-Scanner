<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scan Report - {{ scan.target_url }}</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
            @bottom-center {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10px;
                color: #888;
            }
        }
        body { font-family: "Helvetica Neue", Arial, sans-serif; font-size: 11pt; line-height: 1.4; color: #333; }
        h1 { font-size: 28pt; color: #2c3e50; text-align: center; margin-bottom: 0; }
        h2 { font-size: 18pt; color: #34495e; border-bottom: 2px solid #34495e; padding-bottom: 5px; margin-top: 30px; page-break-before: auto; page-break-after: avoid; }
        h3 { font-size: 14pt; color: #2980b9; margin-top: 20px; }

        .cover-page { text-align: center; page-break-after: always; display: flex; flex-direction: column; justify-content: center; height: 90vh; }
        .cover-page .subtitle { font-size: 16pt; color: #7f8c8d; }
        .cover-page .target { font-family: monospace; font-size: 14pt; background: #ecf0f1; padding: 10px; border-radius: 5px; margin: 30px 0; }

        .toc-title { font-size: 24pt; text-align: center; margin-bottom: 30px; }
        .toc ul { list-style: none; padding: 0; }
        .toc li { margin-bottom: 10px; }

        .summary-box { background: #f8f9fa; padding: 20px; border: 1px solid #e9ecef; border-left: 5px solid #3498db; margin-bottom: 25px; }
        .summary-box h3 { color: #3498db; margin-top: 0; }

        .vuln-item { margin-bottom: 25px; page-break-inside: avoid; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
        .vuln-header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .vuln-body { padding: 15px; background: #fdfdfd; }

        .severity-badge { padding: 5px 10px; border-radius: 4px; color: white; font-weight: bold; }
        .critical { background-color: #c0392b; } .high { background-color: #e74c3c; } .medium { background-color: #f39c12; } .low { background-color: #3498db; }
        .info { background-color: #95a5a6; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10pt; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #ecf0f1; font-weight: bold; }

        pre, code { font-family: "Courier New", monospace; background-color: #ecf0f1; padding: 8px; border-radius: 4px; display: block; white-space: pre-wrap; word-wrap: break-word; font-size: 9pt; }
    </style>
</head>
<body>
    <!-- COVER PAGE -->
    <div class="cover-page">
        <h1>Web Vulnerability Scan Report</h1>
        <p class="subtitle">Confidential Security Assessment</p>
        <div style="flex-grow: 1;"></div>
        <p><strong>Target Assessed:</strong></p>
        <p class="target">{{ scan.target_url }}</p>
        <div style="flex-grow: 1;"></div>
        <p><strong>Date of Assessment:</strong> {{ scan.start_time.strftime('%B %d, %Y') }}</p>
    </div>

    <!-- TABLE OF CONTENTS (Manual) -->
    <div class="toc" style="page-break-after: always;">
        <h1 class="toc-title">Table of Contents</h1>
        <ul>
            <li>1. Executive Summary</li>
            <li>2. Findings Summary</li>
            <li>3. Reconnaissance Details</li>
            <li>4. Vulnerability Details</li>
        </ul>
    </div>

    <!-- EXECUTIVE SUMMARY -->
    <div class="summary-box">
        <h2>1. Executive Summary</h2>
        {% set ai_summary = scan.get_ai_analysis() %}
        {% if ai_summary %}
            <h3>Overall Security Posture</h3>
            <p>{{ ai_summary.executive_summary }}</p>
            <h3>Top Priorities</h3>
            <ul>
            {% for item in ai_summary.top_priorities %}
                <li>{{ item }}</li>
            {% endfor %}
            </ul>
        {% else %}
            <p>An automated analysis of the scan results indicates that the target application has several security weaknesses that require attention. A detailed breakdown is provided in the following sections.</p>
        {% endif %}
    </div>

    <!-- FINDINGS SUMMARY -->
    <h2>2. Findings Summary</h2>
    <table style="width: 60%; margin: 20px auto;">
        <thead><tr><th>Severity</th><th>Count</th></tr></thead>
        <tbody>
            <tr><td><span class="severity-badge critical">Critical</span></td><td>{{ severity_counts.get('Critical', 0) }}</td></tr>
            <tr><td><span class="severity-badge high">High</span></td><td>{{ severity_counts.get('High', 0) }}</td></tr>
            <tr><td><span class="severity-badge medium">Medium</span></td><td>{{ severity_counts.get('Medium', 0) }}</td></tr>
            <tr><td><span class="severity-badge low">Low</span></td><td>{{ severity_counts.get('Low', 0) }}</td></tr>
        </tbody>
    </table>

    <!-- RECONNAISSANCE -->
    {% if scan.recon_findings %}
    <h2>3. Reconnaissance Details</h2>
    <table>
        <thead><tr><th>Tool</th><th>Finding</th><th>Details</th></tr></thead>
        <tbody>
        {% for finding in scan.recon_findings %}
            <tr>
                <td>{{ finding.tool }}</td>
                <td>{{ finding.finding_type }}</td>
                <td><pre style="padding: 2px;">{{ finding.get_details_as_dict() | tojson(indent=2) }}</pre></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- DETAILED VULNERABILITIES -->
    <h2>4. Vulnerability Details</h2>
    {% for vuln in vulnerabilities %}
    <div class="vuln-item">
        <div class="vuln-header {{ vuln.severity|lower }}">
            <h3 style="color: white; margin: 0;">{{ vuln.kb_info.title }}</h3>
            <span class="severity-badge {{ vuln.severity|lower }}">{{ vuln.severity }}</span>
        </div>
        <div class="vuln-body">
            <table>
                <tr><th width="20%">OWASP Top 10</th><td>{{ vuln.kb_info.owasp }}</td></tr>
                <tr><th>CWE</th><td>{{ vuln.kb_info.cwe }}</td></tr>
                <tr><th>Location</th><td><code>{{ vuln.url }}</code></td></tr>
            </table>

            <h3>Description</h3>
            <p>{{ vuln.kb_info.description }}</p>

            <h3>Impact</h3>
            <p>{{ vuln.kb_info.impact }}</p>

            <h3>Technical Details</h3>
            <pre>{{ vuln.get_details_as_dict() | tojson(indent=2) }}</pre>

            {% set ai_sugg = vuln.get_details_as_dict().ai_suggestion %}
            {% if ai_sugg %}
            <h3>AI-Powered Remediation</h3>
            <p><strong>Explanation:</strong> {{ ai_sugg.explanation }}</p>
            <p><strong>Suggested Code Fix (Example):</strong></p>
            <pre>{{ ai_sugg.fixed_code }}</pre>
            {% endif %}
        </div>
    </div>
    {% endfor %}

</body>
</html>